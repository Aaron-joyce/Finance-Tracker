<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker - Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#1e293b',
                    }
                }
            }
        }
    </script>

    <style>
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-btn.active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans antialiased h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col h-full flex-shrink-0">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-2xl font-bold tracking-wider text-blue-400">
                <i class="fa-solid fa-wallet mr-2"></i>FinTracker
            </h1>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button id="btn-plan" onclick="switchTab('plan')"
                class="tab-btn-nav w-full text-left block py-3 px-4 rounded hover:bg-slate-800 transition-all text-blue-400 bg-slate-800">
                <i class="fa-solid fa-clipboard-list w-6"></i> My Plan
            </button>
            <button id="btn-tracker" onclick="switchTab('tracker')"
                class="tab-btn-nav w-full text-left block py-3 px-4 rounded hover:bg-slate-800 transition-all text-slate-400">
                <i class="fa-solid fa-magnifying-glass-dollar w-6"></i> Tracker
            </button>
            <button id="btn-analysis" onclick="switchTab('analysis')"
                class="tab-btn-nav w-full text-left block py-3 px-4 rounded hover:bg-slate-800 transition-all text-slate-400">
                <i class="fa-solid fa-chart-pie w-6"></i> Analysis
            </button>
        </nav>

        <div class="p-4 border-t border-slate-700">
            <div class="flex items-center gap-3 mb-4 px-2">
                <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-xl">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div>
                    <p class="text-sm font-semibold" th:text="${username}">User</p>
                </div>
            </div>
            <a href="/"
                class="block w-full py-2 px-4 text-center rounded border border-slate-600 text-slate-300 hover:bg-slate-800 hover:text-white transition-all">
                <i class="fa-solid fa-right-from-bracket mr-2"></i> Logout
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm p-6 flex justify-between items-center z-10">
            <h2 id="pageTitle" class="text-2xl font-bold text-gray-800">My Plan</h2>
            <div class="flex items-center gap-4">
                <button class="text-gray-500 hover:text-blue-600 transition"><i
                        class="fa-solid fa-bell text-xl"></i></button>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-6">

            <!-- Tab 1: My Plan (Budget Rules) -->
            <div id="tab-plan" class="tab-content active space-y-6">
                <!-- KPI & Chart Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Savings Widget -->
                    <div
                        class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between h-64">
                        <div>
                            <p class="text-sm font-semibold text-gray-500 uppercase">Projected Savings</p>
                            <h3 class="text-3xl font-bold text-gray-800 mt-2">₹<span
                                    th:text="${projectedSavings}">0.00</span></h3>
                            <p class="text-xs text-slate-400 mt-1">Based on Income - Expenses</p>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-lg text-blue-600 w-fit"><i
                                class="fa-solid fa-piggy-bank text-xl"></i></div>
                    </div>

                    <!-- Chart Widget -->
                    <div
                        class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 md:col-span-2 h-64 flex items-center justify-center">
                        <div class="w-full h-full flex items-center justify-center">
                            <canvas id="plannedDistributionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Add Rule Form -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Add Budget Rule</h3>
                    <form id="addRuleForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                        <!-- ... same form fields ... -->
                        <div class="lg:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                            <input type="text" id="ruleTitle" placeholder="e.g. Monthly Rent" required
                                class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                            <input type="number" id="ruleAmount" placeholder="0.00" required
                                class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Period</label>
                            <select id="rulePeriod" class="w-full px-3 py-2 border rounded-lg bg-white">
                                <option value="MONTHLY">Monthly</option>
                                <option value="YEARLY">Yearly</option>
                                <option value="DAILY">Daily</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select id="ruleCategory" class="w-full px-3 py-2 border rounded-lg bg-white">
                                <option th:each="cat : ${categories}" th:value="${cat}" th:text="${cat}">OTHER</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                            <select id="ruleType" class="w-full px-3 py-2 border rounded-lg bg-white">
                                <option value="EXPENSE">Expense</option>
                                <option value="INCOME">Income</option>
                            </select>
                        </div>
                        <div class="lg:col-span-1">
                            <button type="submit"
                                class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700">Add</button>
                        </div>
                    </form>
                </div>

                <!-- Budget Rules Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Income Rules -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 text-green-600"><i
                                class="fa-solid fa-arrow-trend-up mr-2"></i>Income Sources</h3>
                        <table class="w-full text-left">
                            <thead class="bg-green-50 text-green-800">
                                <tr>
                                    <th class="p-3">Title</th>
                                    <th class="p-3 text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="rule : ${incomeRules}" class="border-b">
                                    <td class="p-3">
                                        <div class="font-medium" th:text="${rule.title}">Salary</div>
                                        <div class="text-xs text-gray-400" th:text="${rule.period}">MONTHLY</div>
                                    </td>
                                    <td class="p-3 text-right font-bold text-green-600" th:text="${rule.amount}">5000
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(incomeRules)}">
                                    <td colspan="2" class="p-3 text-center text-gray-400">No income rules yet.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Expense Rules -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 text-red-500"><i
                                class="fa-solid fa-arrow-trend-down mr-2"></i>Planned Expenses</h3>
                        <table class="w-full text-left">
                            <thead class="bg-red-50 text-red-800">
                                <tr>
                                    <th class="p-3">Title</th>
                                    <th class="p-3 text-right">Amount</th>
                                    <th class="p-3">Category</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="rule : ${expenseRules}" class="border-b">
                                    <td class="p-3">
                                        <div class="font-medium" th:text="${rule.title}">Rent</div>
                                        <div class="text-xs text-gray-400" th:text="${rule.period}">MONTHLY</div>
                                    </td>
                                    <td class="p-3 text-right font-bold text-red-500" th:text="${rule.amount}">1000</td>
                                    <td class="p-3 text-sm text-gray-600" th:text="${rule.category}">RENT</td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(expenseRules)}">
                                    <td colspan="3" class="p-3 text-center text-gray-400">No expense rules yet.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Tracker (Transactions) -->
            <div id="tab-tracker" class="tab-content space-y-6">

                <!-- Widgets Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Monthly Spending -->
                    <div
                        class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between h-32">
                        <div>
                            <p class="text-sm font-semibold text-gray-500 uppercase">Spent This Month</p>
                            <h3 class="text-3xl font-bold text-gray-800 mt-2 text-red-500">₹<span
                                    th:text="${monthlySpending}">0.00</span></h3>
                        </div>
                        <div class="p-3 bg-red-50 rounded-lg text-red-600 w-fit"><i
                                class="fa-solid fa-receipt text-xl"></i></div>
                    </div>

                    <!-- Today's Spending -->
                    <div
                        class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between h-32">
                        <div>
                            <p class="text-sm font-semibold text-gray-500 uppercase">Spent Today</p>
                            <h3 class="text-3xl font-bold text-gray-800 mt-2 text-orange-500">₹<span
                                    th:text="${todaysSpending}">0.00</span></h3>
                        </div>
                        <div class="p-3 bg-orange-50 rounded-lg text-orange-600 w-fit"><i
                                class="fa-solid fa-bolt text-xl"></i></div>
                    </div>
                </div>

                <!-- Chart Row -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-80">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Daily Spending (Last 7 Days)</h3>
                    <div class="w-full h-64">
                        <canvas id="dailySpendingChart"></canvas>
                    </div>
                </div>

                <!-- Form & History Row -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Add Transaction Form -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 lg:col-span-1 h-fit">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Log Transaction</h3>
                        <form id="addTxForm" class="space-y-4"> <!-- Stacked form -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <input type="text" id="txDesc" placeholder="e.g. Grocery" required
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                                <input type="number" id="txAmount" placeholder="0.00" required
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                <select id="txCategory" class="w-full px-3 py-2 border rounded-lg bg-white">
                                    <option th:each="cat : ${categories}" th:value="${cat}" th:text="${cat}">OTHER
                                    </option>
                                </select>
                            </div>
                            <button type="submit"
                                class="w-full bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700">Log
                                Transaction</button>
                        </form>
                    </div>

                    <!-- History -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 lg:col-span-2">
                        <!-- ... history table ... -->
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Recent History</h3>
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-500">
                                <tr>
                                    <th class="p-3">Date</th>
                                    <th class="p-3">Description</th>
                                    <th class="p-3 text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="tx : ${recentTransactions}" class="border-b">
                                    <td class="p-3 text-gray-500 text-sm"
                                        th:text="${#temporals.format(tx.timestamp, 'dd MMM HH:mm')}"></td>
                                    <td class="p-3" th:text="${tx.description}">Coffee</td>
                                    <td class="p-3 text-right font-medium"
                                        th:classappend="${tx.category == T(com.ajax.finance_tracker.model.Category).SALARY} ? 'text-green-600' : 'text-red-500'"
                                        th:text="${tx.amount}">5.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div> <!-- Close grid -->
            </div> <!-- Close tab-tracker -->

            <!-- Tab 3: Analysis (Variance) -->
            <div id="tab-analysis" class="tab-content space-y-6">
                <!-- Grouped Bar Chart -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-96">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Plan vs Actual (Monthly)</h3>
                    <div class="w-full h-80 relative">
                        <canvas id="planVsActualChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Pie Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-96">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Actual Expense Breakdown</h3>
                        <div class="w-full h-80 flex justify-center relative">
                            <canvas id="expenseBreakdownChart"></canvas>
                        </div>
                    </div>

                    <!-- Variance List -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-96 overflow-y-auto">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">Detailed Variance</h3>

                        <div th:each="variance : ${varianceReport}" class="mb-6">
                            <div class="flex justify-between items-end mb-1">
                                <div>
                                    <h4 class="font-bold text-gray-800">
                                        <span th:text="${variance.category}">FOOD</span>
                                        <span class="text-xs font-normal text-gray-500"
                                            th:text="'(' + ${variance.type} + ')'"></span>
                                    </h4>
                                    <p class="text-xs text-gray-500">Planned: <span
                                            th:text="${variance.planned}">500</span>
                                        | Actual: <span th:text="${variance.actual}">450</span></p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold"
                                        th:classappend="${variance.remaining < 0} ? 'text-red-500' : 'text-green-600'">
                                        <span
                                            th:text="${variance.remaining > 0 ? (variance.type == T(com.ajax.finance_tracker.budget.BudgetRule.Type).INCOME ? 'Extra: ' : 'Saved: ') + variance.remaining : 'Diff: ' + variance.remaining.abs()}">Rem:
                                            50</span>
                                    </p>
                                </div>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="h-2.5 rounded-full"
                                    th:classappend="${(variance.type == T(com.ajax.finance_tracker.budget.BudgetRule.Type).EXPENSE && variance.percentUsed > 100) || (variance.type == T(com.ajax.finance_tracker.budget.BudgetRule.Type).INCOME && variance.percentUsed < 100)} ? 'bg-red-500' : 'bg-blue-600'"
                                    th:style="'width: ' + ${T(java.lang.Math).min(variance.percentUsed, 100.0)} + '%'">
                                </div>
                            </div>
                        </div>

                        <div th:if="${#lists.isEmpty(varianceReport)}" class="text-center py-10 text-gray-400">
                            No data to analyze yet. Set up your plan and log some transactions!
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const accountId = /*[[${username}]]*/ 'user';

        // Data from Controller
        const expenseRules = /*[[${expenseRules}]]*/[];
        const dailyKeys = /*[[${dailySpendingKeys}]]*/[];
        const dailyValues = /*[[${dailySpendingValues}]]*/[];
        const varianceData = /*[[${varianceReport}]]*/[];

        // Fix 1 Data
        const chartCategories = /*[[${chartCategories}]]*/[];
        const budgetValues = /*[[${budgetValues}]]*/[];
        const actualValues = /*[[${actualValues}]]*/[];
        /*]]>*/
    </script>

    <script>
        // --- 1. Planned Distribution (Doughnut) ---
        if (document.getElementById('plannedDistributionChart')) {
            const ctx1 = document.getElementById('plannedDistributionChart').getContext('2d');
            new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: expenseRules.map(r => r.category),
                    datasets: [{
                        data: expenseRules.map(r => r.amount),
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#a855f7', '#ec4899', '#64748b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } }
                }
            });
        }

        // --- 2. Daily Spending (Bar - Last 7 Days) ---
        if (document.getElementById('dailySpendingChart')) {
            const ctx2 = document.getElementById('dailySpendingChart').getContext('2d');
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: dailyKeys,
                    datasets: [{
                        label: 'Daily Spending',
                        data: dailyValues,
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- 3. Plan vs Actual (Grouped Bar) ---
        // --- 3. Plan vs Actual (Grouped Bar) ---
        if (document.getElementById('planVsActualChart')) {
            try {
                console.log('Initializing Plan vs Actual Chart');
                console.log('Categories:', chartCategories);
                console.log('Budget:', budgetValues);
                console.log('Actual:', actualValues);

                const ctx3 = document.getElementById('planVsActualChart').getContext('2d');
                new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: chartCategories && chartCategories.length > 0 ? chartCategories : ['No Data'],
                        datasets: [
                            {
                                label: 'Planned',
                                data: budgetValues || [],
                                backgroundColor: '#94a3b8',
                                borderRadius: 4
                            },
                            {
                                label: 'Actual',
                                data: actualValues || [],
                                backgroundColor: (actualValues || []).map((v, i) => {
                                    const planned = (budgetValues && budgetValues[i]) || 0;
                                    return v > planned ? '#ef4444' : '#22c55e';
                                }),
                                borderRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            } catch (err) {
                console.error('Error initializing Plan vs Actual Chart:', err);
            }
        }

        // --- 4. Actual Expense Breakdown (Pie) ---
        if (document.getElementById('expenseBreakdownChart')) {
            const expensesOnly = varianceData.filter(v => v.type === 'EXPENSE' && v.actual > 0);
            const ctx4 = document.getElementById('expenseBreakdownChart').getContext('2d');

            new Chart(ctx4, {
                type: 'pie',
                data: {
                    labels: expensesOnly.map(v => v.category),
                    datasets: [{
                        data: expensesOnly.map(v => v.actual),
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#a855f7', '#ec4899', '#64748b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }
    </script>

    <script>
        // Init logic
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const tab = params.get('tab') || 'plan';
            switchTab(tab);
        });

        function switchTab(tabName) {
            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('tab', tabName);
            history.pushState(null, '', url);

            // Hide all contents
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));

            // Reset all nav buttons
            document.querySelectorAll('.tab-btn-nav').forEach(el => {
                el.classList.remove('text-blue-400', 'bg-slate-800');
                el.classList.add('text-slate-400');
            });

            // Show selected content
            document.getElementById('tab-' + tabName).classList.add('active');

            // Highlight selected nav button
            const btn = document.getElementById('btn-' + tabName);
            if (btn) {
                btn.classList.remove('text-slate-400');
                btn.classList.add('text-blue-400', 'bg-slate-800');
            }

            // Update Headers
            const titles = { 'plan': 'My Plan', 'tracker': 'Tracker', 'analysis': 'Analysis' };
            if (titles[tabName]) {
                document.getElementById('pageTitle').innerText = titles[tabName];
            }
        }

        // Init Form Listeners
        document.getElementById('addRuleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                title: document.getElementById('ruleTitle').value,
                amount: document.getElementById('ruleAmount').value,
                period: document.getElementById('rulePeriod').value,
                type: document.getElementById('ruleType').value,
                category: document.getElementById('ruleCategory').value,
                currency: 'INR'
            };

            try {
                const response = await fetch('/api/budget/rules?accountId=' + accountId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to add rule');
                }
            } catch (err) {
                console.error(err);
                alert('Error adding rule');
            }
        });

        document.getElementById('addTxForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                description: document.getElementById('txDesc').value,
                amount: document.getElementById('txAmount').value,
                category: document.getElementById('txCategory').value
            };

            try {
                const response = await fetch('/api/tracking/transactions?accountId=' + accountId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to add transaction');
                }
            } catch (err) {
                console.error(err);
                alert('Error adding transaction');
            }
        });
    </script>
</body>

</html>